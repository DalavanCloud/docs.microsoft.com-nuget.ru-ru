---
title: "Восстановление пакетов NuGet | Документы Майкрософт"
author: kraigb
ms.author: kraigb
manager: ghogen
ms.date: 02/12/2018
ms.topic: article
ms.prod: nuget
ms.technology: 
ms.assetid: a7bf21da-86ae-4c2d-8750-04ff53f41967
description: "Описание того, как NuGet восстанавливает пакеты, от которых зависит проект, включая отключение восстановления и ограничения версий."
keywords: "восстановление пакетов NuGet, установка пакетов NuGet, установка пакета, восстановление пакетов, версии зависимостей, отключение автоматического восстановления, ограничение версий пакетов"
ms.reviewer:
- karann-msft
- unniravindranathan
ms.openlocfilehash: 761ef86a70e0a681449dc9fe86d6a52ac2b19bb1
ms.sourcegitcommit: 74c21b406302288c158e8ae26057132b12960be8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/15/2018
---
# <a name="package-restore"></a><span data-ttu-id="f3f3e-104">Восстановление пакетов</span><span class="sxs-lookup"><span data-stu-id="f3f3e-104">Package Restore</span></span>

<span data-ttu-id="f3f3e-105">Чтобы очистить среду разработки и уменьшить размер репозитория, **функция восстановления пакетов** NuGet устанавливает все указанные в ссылках пакеты перед сборкой проекта.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-105">To promote a cleaner development environment and to reduce repository size, NuGet **Package Restore** installs all referenced packages before a project is built.</span></span> <span data-ttu-id="f3f3e-106">Эта широко применяемая функция, &mdash;доступная в Visual Studio, .NET Core 2.0+ и xbuild в Mono&mdash;, гарантирует доступность всех зависимостей в проекте без необходимости сохранения этих пакетов в системе управления исходным кодом (сведения о том, как настроить репозиторий, чтобы исключить двоичные файлы пакетов, см. в статье [Пропуск пакетов NuGet в системах управления исходным кодом](../consume-packages/packages-and-source-control.md)).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-106">This widely-used feature&mdash;available in Visual Studio, .NET Core 2.0+, and xbuild on Mono&mdash;ensures that all dependencies are available in a project without requiring those packages to be stored in source control (see [Packages and Source Control](../consume-packages/packages-and-source-control.md) on how to configure your repository to exclude package binaries).</span></span> <span data-ttu-id="f3f3e-107">Пакеты можно также восстановить вручную в любое время.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-107">You can also manually restore packages at any time.</span></span>

<span data-ttu-id="f3f3e-108">Дополнительные сведения о восстановлении пакетов на серверах сборки см. в разделе [Восстановление пакетов с помощью TFBuild](../consume-packages/team-foundation-build.md).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-108">For additional details on package restore on build servers, see [Package restore with TFBuild](../consume-packages/team-foundation-build.md).</span></span>

## <a name="package-restore-overview"></a><span data-ttu-id="f3f3e-109">Обзор восстановления пакетов</span><span class="sxs-lookup"><span data-stu-id="f3f3e-109">Package restore overview</span></span>

<span data-ttu-id="f3f3e-110">При восстановлении пакетов сначала устанавливаются необходимые прямые зависимости проекта, а затем остальные зависимости этих пакетов во всей схеме зависимостей.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-110">Restoring packages first installs the direct dependencies of a project as needed, then installing any dependencies of those packages throughout the entire dependency graph.</span></span>

<span data-ttu-id="f3f3e-111">Если пакет не установлен, NuGet сначала попытается извлечь его из [кэша](../consume-packages/managing-the-nuget-cache.md).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-111">If a package is not already installed, NuGet first attempts to retrieve it from the [cache](../consume-packages/managing-the-nuget-cache.md).</span></span> <span data-ttu-id="f3f3e-112">Если пакета нет в кэше, NuGet пытается скачать (и кэшировать) его из всех включенных источников (см. статью [Настройка поведения NuGet](Configuring-NuGet-Behavior.md)), которые также отображаются в списке **Сервис > Параметры > Диспетчер пакетов NuGet > Источники пакетов** в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-112">If the package is not in the cache, NuGet then attempts to download (and cache) the package from all enabled sources (see [Configuring NuGet behavior](Configuring-NuGet-Behavior.md)); sources also appear in the  **Tools > Options > NuGet Package Manager > Package Sources** list in Visual Studio).</span></span> <span data-ttu-id="f3f3e-113">NuGet игнорирует порядок источников пакетов, используя пакет из любого источника, первым ответившего на запросы.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-113">NuGet ignores the order of package sources, using the package from whichever source is first to respond to requests.</span></span>

> [!Note]
> <span data-ttu-id="f3f3e-114">NuGet не сообщает о сбое восстановления пакета до проверки всех источников.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-114">NuGet does not indicate a failure to restore a package until all the sources have been checked.</span></span> <span data-ttu-id="f3f3e-115">После проверки NuGet сообщает о сбое только для последнего источника в списке.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-115">At that time, NuGet reports the failure for only the last source in the list.</span></span> <span data-ttu-id="f3f3e-116">Такая ошибка означает, что пакет отсутствовал и во *всех* других источниках, хотя отдельные ошибки для них не выдавались.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-116">The error implies that the package wasn't present on *any* of the other sources, even though errors are not shown for each of those sources individually.</span></span>

<span data-ttu-id="f3f3e-117">Восстановление пакета инициируется с помощью следующих методов:</span><span class="sxs-lookup"><span data-stu-id="f3f3e-117">Package restore is triggered in the following ways:</span></span>

- <span data-ttu-id="f3f3e-118">**Интерфейс командной строки dotnet**: выполните команду [dotnet restore](/dotnet/core/tools/dotnet-restore?tabs=netcore2x) для восстановления пакетов в файле проекта (дополнительные сведения см. в статье [Ссылки на пакеты (PackageReference) в файлах проектов](../consume-packages/package-references-in-project-files.md)).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-118">**dotnet CLI**: use the [dotnet restore](/dotnet/core/tools/dotnet-restore?tabs=netcore2x) command, which restores packages listed in the project file (see [PackageReference](../consume-packages/package-references-in-project-files.md)).</span></span> <span data-ttu-id="f3f3e-119">При использовании .NET Core версии 2.0 и более поздней автоматическое восстановление доступно с помощью команд `dotnet build` и `dotnet run`.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-119">With .NET Core 2.0 and later, restore is done automatically with `dotnet build` and `dotnet run`.</span></span>

- <span data-ttu-id="f3f3e-120">**Пользовательский интерфейс диспетчера пакетов (Visual Studio в Windows)**: пакеты автоматически восстанавливаются при создании проекта из шаблона и формировании проекта (как описано в разделе [Включение и отключение восстановления пакетов](#enabling-and-disabling-package-restore)).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-120">**Package Manager UI (Visual Studio on Windows)**: Packages are restored automatically when creating a project from a template and when building a project (subject to the option described in [Enabling and disabling package restore](#enabling-and-disabling-package-restore)).</span></span> <span data-ttu-id="f3f3e-121">В NuGet 4.0 и более поздних версий также доступно автоматическое восстановление при изменении проекта на основе пакета SDK для .NET Core.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-121">In NuGet 4.0+, restore also happens automatically when changes are made to a .NET Core SDK-based project.</span></span>

    <span data-ttu-id="f3f3e-122">Чтобы восстановить пакет вручную, щелкните правой кнопкой мыши решение в обозревателе решений и выберите **Восстановить пакеты NuGet**.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-122">To restore manually, right-click the solution in Solution Explorer and select **Restore NuGet Packages**.</span></span> <span data-ttu-id="f3f3e-123">Если один или несколько отдельных пакетов по-прежнему не установлены надлежащим образом (то есть для них в обозревателе решений отображается значок ошибки), удалите затрагиваемые пакеты с помощью пользовательского интерфейса диспетчера пакетов, после чего повторно установите их.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-123">If one or more individual packages are still not installed properly (meaning that Solution Explorer shows an error icon), then use the Package Manager UI to uninstall and reinstall the affected packages.</span></span> <span data-ttu-id="f3f3e-124">См. раздел [Повторная установка и обновление пакетов](../consume-packages/reinstalling-and-updating-packages.md)</span><span class="sxs-lookup"><span data-stu-id="f3f3e-124">See [Reinstalling and updating packages](../consume-packages/reinstalling-and-updating-packages.md)</span></span>

    <span data-ttu-id="f3f3e-125">Если отображается ошибка "Данный проект ссылается на пакеты NuGet, отсутствующие на этом компьютере" или "Необходимо восстановить один или несколько пакетов NuGet, однако это невозможно без вашего согласия", включите автоматическое восстановление, следуя инструкциям в разделе [Включение и отключение восстановления пакетов](#enabling-and-disabling-package-restore).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-125">If you see the error "This project references NuGet package(s) that are missing on this computer" or "One or more NuGet packages need to be restored but couldn't be because consent has not been granted," turn on automatic restore by following the instructions under [Enabling and disabling package restore](#enabling-and-disabling-package-restore).</span></span>

- <span data-ttu-id="f3f3e-126">**Интерфейс командной строки NuGet**: выполните команду [nuget restore](../tools/cli-ref-restore.md) для восстановления пакетов в файле проекта (дополнительные сведения см. в статье [Ссылки на пакеты (PackageReference) в файлах проектов](../consume-packages/package-references-in-project-files.md)) или файле [packages.config](../reference/packages-config.md).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-126">**NuGet CLI**: use the [nuget restore](../tools/cli-ref-restore.md) command, which restores packages listed in the project file (see [PackageReference](../consume-packages/package-references-in-project-files.md)) or in a [packages.config](../reference/packages-config.md) file.</span></span> <span data-ttu-id="f3f3e-127">Вы можете также указать файл решения.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-127">You can also specify a solution file.</span></span>

- <span data-ttu-id="f3f3e-128">**MSBuild**: выполните команду [msbuild /t:restore](../reference/msbuild-targets.md#restore-target) для восстановления пакетов в файле проекта (дополнительные сведения см. в статье [Ссылки на пакеты (PackageReference) в файлах проектов](../consume-packages/package-references-in-project-files.md)).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-128">**MSBuild**: use the [msbuild /t:restore](../reference/msbuild-targets.md#restore-target) command, which restores packages packages listed in the project file (see [PackageReference](../consume-packages/package-references-in-project-files.md)).</span></span> <span data-ttu-id="f3f3e-129">Доступно только в NuGet версии 4.x и более поздних и MSBuild версии 15.1 и более поздних, включенных в Visual Studio 2017.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-129">Available only in NuGet 4.x+ and MSBuild 15.1+, which are included with Visual Studio 2017.</span></span> <span data-ttu-id="f3f3e-130">`nuget restore` и `dotnet restore` используют эту команду для подходящих проектов.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-130">`nuget restore` and `dotnet restore` both use this command for applicable projects.</span></span>

- <span data-ttu-id="f3f3e-131">**Visual Studio Team Services**: при создании определения сборки в Team Services включите в него задачу [восстановления NuGet](/vsts/build-release/tasks/package/nuget#restore-nuget-packages) или [.NET Core](/vsts/build-release/tasks/build/dotnet-core#restore-nuget-packages), а затем добавьте задачу сборки.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-131">**Visual Studio Team Services**: When creating a build definition on Team Services, include the [NuGet restore](/vsts/build-release/tasks/package/nuget#restore-nuget-packages) or [.NET Core Restore](/vsts/build-release/tasks/build/dotnet-core#restore-nuget-packages) task in the definition before any build task.</span></span> <span data-ttu-id="f3f3e-132">Эта задача по умолчанию входит в несколько шаблонов сборки.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-132">This task is included by default in a number of build templates.</span></span>

- <span data-ttu-id="f3f3e-133">**Team Foundation Server**: в TFS 2013 и более поздних версий пакеты восстанавливаются автоматически во время сборки при условии, что вы используете шаблон командной сборки для TFS 2013 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-133">**Team Foundation Server**: TFS 2013 and later automatically restores packages during build, provided that you're using a Team Build Template for TFS 2013 or later.</span></span> <span data-ttu-id="f3f3e-134">Для более ранней версии TFS можно просто включить шаг сборки, чтобы вызвать один из параметров восстановления из командной строки, как описано выше.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-134">For earlier version of TFS, you can include a build step to invoke one of the command-line restore options above.</span></span> <span data-ttu-id="f3f3e-135">При необходимости можно перенести шаблон сборки в TFS 2013.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-135">You can optionally migrate the build template to TFS 2013.</span></span> <span data-ttu-id="f3f3e-136">Дополнительные сведения см. в статье [Настройка восстановления пакетов с помощью сборки Team Foundation](../consume-packages/team-foundation-build.md).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-136">For more information, see the [Walkthrough of package restore with Team Foundation Build](../consume-packages/team-foundation-build.md).</span></span>

## <a name="enabling-and-disabling-package-restore"></a><span data-ttu-id="f3f3e-137">Включение и отключение восстановления пакетов</span><span class="sxs-lookup"><span data-stu-id="f3f3e-137">Enabling and disabling package restore</span></span>

<span data-ttu-id="f3f3e-138">Восстановление пакетов можно включить в меню **Сервис > Параметры > Диспетчер пакетов NuGet** в Visual Studio:</span><span class="sxs-lookup"><span data-stu-id="f3f3e-138">Package restore is primarily enabled through **Tools > Options > NuGet Package Manager** in Visual Studio:</span></span>

![Управление поведением восстановления пакетов с помощью параметров диспетчера пакетов NuGet](media/Restore-01-AutoRestoreOptions.png)

- <span data-ttu-id="f3f3e-140">**Разрешить NuGet скачивать отсутствующие пакеты**: определяет все формы восстановления пакетов, изменяя `packageRestore/enabled` в файле `NuGet.Config`, как показано ниже (`%AppData%\NuGet\NuGet.Config` в Windows, `~/.nuget/NuGet/NuGet.Config` в Mac/Linux).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-140">**Allow NuGet to download missing packages**: controls all forms of package restore by changing the `packageRestore/enabled` setting in the `NuGet.Config` file as shown below (`%AppData%\NuGet\NuGet.Config` on Windows, `~/.nuget/NuGet/NuGet.Config` on Mac/Linux).</span></span> <span data-ttu-id="f3f3e-141">В Visual Studio этот параметр обеспечивает работу команды **Восстановить пакеты NuGet** в контекстном меню решения.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-141">In Visual Studio, this setting allows the **Restore NuGet Packages** command on the solution's context menu to work.</span></span>

    ```xml
    <configuration>
        <packageRestore>
            <!-- The 'enabled' key is True when the "Allow NuGet to download missing packages" checkbox is set.
                 Clearing the box sets this to False, disabling command-line, automatic, and MSBuild-Integrated restore. -->
            <add key="enabled" value="True" />
        </packageRestore>
    </configuration>
    ```
    <br/>
    > [!Note]
    >  <span data-ttu-id="f3f3e-142">Параметр `packageRestore/enabled` можно переопределить на глобальном уровне, задав для переменной среды с именем **EnableNuGetPackageRestore** значение TRUE или FALSE перед запуском Visual Studio или началом сборки.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-142">The `packageRestore/enabled` setting can be overridden globally by setting an environment variable called **EnableNuGetPackageRestore** with a value of TRUE or FALSE before launching Visual Studio or starting a build.</span></span>

- <span data-ttu-id="f3f3e-143">**Автоматически проверять отсутствие пакетов при сборке в Visual Studio**: управляет автоматическим восстановлением, изменяя параметр `packageRestore/automatic` в файле `NuGet.Config`, как показано ниже (`%AppData%\NuGet\NuGet.Config` в Windows, `~/.nuget/NuGet/NuGet.Config` в Mac/Linux).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-143">**Automatically check for missing packages during build in Visual Studio**: controls automatic restore by changing the `packageRestore/automatic` setting in the `NuGet.Config` file as shown below (`%AppData%\NuGet\NuGet.Config` on Windows, `~/.nuget/NuGet/NuGet.Config` on Mac/Linux).</span></span> <span data-ttu-id="f3f3e-144">Когда этот параметр задан, при запуске сборки из Visual Studio все отсутствующие пакеты восстанавливаются автоматически.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-144">When this option is set, running a build from Visual Studio automatically restores any missing packages.</span></span> <span data-ttu-id="f3f3e-145">Этот параметр не затрагивает сборки, запускаемые из командной строки с помощью MSBuild.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-145">The option does not affect builds run from the command line using MSBuild.</span></span>

    ```xml
    ...
    <configuration>
        <packageRestore>
            <!-- The 'automatic' key is set to True when the "Automatically check for missing packages during
                 build in Visual Studio" checkbox is set. Clearing the box sets this to False and disables
                 automatic restore. -->
            <add key="automatic" value="True" />
        </packageRestore>
    </configuration>
    ```

<span data-ttu-id="f3f3e-146">Справочную информацию см. в разделе [Файл конфигурации NuGet — packageRestore](../reference/nuget-config-file.md#packagerestore-section).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-146">For reference, see the [NuGet config file - packageRestore section](../reference/nuget-config-file.md#packagerestore-section).</span></span>

<span data-ttu-id="f3f3e-147">В некоторых случаях разработчику или организации может потребоваться включить или отключить восстановление пакетов на компьютере для всех пользователей.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-147">In some cases, a developer or company might want to enable or disable package restore for all users on a computer.</span></span> <span data-ttu-id="f3f3e-148">Это можно сделать, добавив указанные выше параметры в файл глобальной конфигурации NuGet, находящийся в `%ProgramData%\NuGet\Config[\{IDE}[\{Version}[\{SKU}]]]`.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-148">This is done by adding the same settings above to the global NuGet configuration file located in `%ProgramData%\NuGet\Config[\{IDE}[\{Version}[\{SKU}]]]`.</span></span> <span data-ttu-id="f3f3e-149">После этого отдельные пользователи могут выборочно включить восстановление на уровне проекта по необходимости.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-149">Individual users can then selectively enable restore as needed on a project level.</span></span> <span data-ttu-id="f3f3e-150">Точные сведения о том, как NuGet устанавливает приоритеты для нескольких файлов конфигурации, см. в разделе [Порядок применения параметров](../consume-packages/configuring-nuget-behavior.md#how-settings-are-applied).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-150">See [Configuring NuGet behavior](../consume-packages/configuring-nuget-behavior.md#how-settings-are-applied) for exact details on how NuGet prioritizes multiple config files.</span></span>

## <a name="constraining-package-versions-with-restore"></a><span data-ttu-id="f3f3e-151">Ограничение версий пакетов при восстановлении</span><span class="sxs-lookup"><span data-stu-id="f3f3e-151">Constraining package versions with restore</span></span>

<span data-ttu-id="f3f3e-152">При восстановлении пакетов любым из методов NuGet учитывает все ограничения, указанные в `packages.config` или файле проекта:</span><span class="sxs-lookup"><span data-stu-id="f3f3e-152">When restoring packages through any method, NuGet honors any constraints specified in `packages.config` or the project file:</span></span>

- <span data-ttu-id="f3f3e-153">`packages.config`: укажите диапазон версий в свойстве `allowedVersion` зависимости.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-153">`packages.config`: Specify a version range in the `allowedVersion` property of the dependency.</span></span> <span data-ttu-id="f3f3e-154">Дополнительные сведения см. в разделе [Ограничение версий для обновления](../consume-packages/reinstalling-and-updating-packages.md#constraining-upgrade-versions).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-154">See [Reinstalling and updating packages](../consume-packages/reinstalling-and-updating-packages.md#constraining-upgrade-versions).</span></span> <span data-ttu-id="f3f3e-155">Пример:</span><span class="sxs-lookup"><span data-stu-id="f3f3e-155">For example:</span></span>

    ```xml
    <package id="Newtonsoft.json" version="6.0.4" allowedVersions="[6,7)" />
    ```

- <span data-ttu-id="f3f3e-156">PackageReference: укажите диапазон версий непосредственно с номером версии зависимости.</span><span class="sxs-lookup"><span data-stu-id="f3f3e-156">PackageReference: Specify a version range directly with the dependency's version number.</span></span> <span data-ttu-id="f3f3e-157">Пример:</span><span class="sxs-lookup"><span data-stu-id="f3f3e-157">For example:</span></span>

    ```xml
    <PackageReference Include="Newtonsoft.json" Version="[6, 7)" />
    ```

<span data-ttu-id="f3f3e-158">Во всех случаях используйте нотацию, описанную в статье [Управление версиями пакета](../reference/package-versioning.md).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-158">In all cases, use the notation described in [Package versioning](../reference/package-versioning.md).</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="f3f3e-159">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="f3f3e-159">Troubleshooting</span></span>

<span data-ttu-id="f3f3e-160">Дополнительные сведения см. в статье [Устранение ошибок при восстановлении пакетов в Visual Studio](package-restore-troubleshooting.md).</span><span class="sxs-lookup"><span data-stu-id="f3f3e-160">See [Troubleshooting package restore](package-restore-troubleshooting.md).</span></span>